#
# Copyright (c) 2019, Manfred Constapel
# This file is licensed under the terms of the MIT license.
#

#
# xds110 support
#

import sys
import time
import array

from lib.ports import *

from lib.utility import *
from lib.shell import *

# ------------------------------------------

XDS_USB = (0x0451, 0xbef3)

# ------------------------------------------

def xds_reset(dev, delay=100):
    #_ = {0:'CDC Communication',
    #     1:'CDC Data', 2:'Vendor Specific', 3:'CDC Communication',
    #     4:'CDC Data', 5:'Human Interface Device', 6:'Vendor Specific'}
    ep = usb_point(dev, 2, 2)
    if ep is None: return False
    for v in ('00', '01') * 2:
        ep.write(hex2dec('{} {} {} {}'.format('2a', '02', '00', '0e {}'.format(v))))
        time.sleep(delay / 1000)
    return True

# ------------------------------------------

__scan_test__ = (

    '2a 01 00 01',
    '2a 01 00 03',                   '2a 05 00 04 00 00 00 00',    
    '2a 01 00 06', '2a 02 00 05 00', '2a 05 00 07 88 13 00 00',
                   '2a 02 00 05 01', '2a 05 00 07 a0 86 01 00',
                                     '2a 05 00 2b 01 00 00 00',    
    '2a 01 00 06', '2a 02 00 05 00', '2a 05 00 07 88 13 00 00',
                   '2a 02 00 05 01', '2a 05 00 07 a0 86 01 00', '2a 09 00 09 01 00 00 00 01 00 00 00',
    
    '2a 01 00 1a',
    '2a 01 00 2f',
    '2a 01 00 02',
    
    '2a 01 00 01',
    '2a 01 00 03',                   '2a 05 00 04 00 00 00 00',
    '2a 01 00 06', '2a 02 00 05 00', '2a 05 00 07 88 13 00 00',
                   '2a 02 00 05 01', '2a 05 00 07 a0 86 01 00',
                                     '2a 05 00 2b 01 00 00 00',

    '2a 10 00 0a 00 08 04 01 06 01 00 00 00 00 00 00 01 00 01',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),
 
    '2a 10 00 0a 00 08 03 01 05 01 00 00 00 00 00 00 01 00 01',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),

    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 ff ff ff ff',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),
    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 00 00 00 00',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 e2 e0 03 fe',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('e2 e0 03 fe',)*4*16)),
    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 1d 1f fc 01',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('1d 1f fc 01',)*4*16)),
    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 aa cc 33 55',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('aa cc 33 55',)*4*16)),
    '2a 15 00 0b 20 00 04 01 06 01 00 00 00 00 00 00 01 00 04 00 55 33 cc aa',
    '2a 13 01 0c 00 08 04 01 06 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('55 33 cc aa',)*4*16)),

    '2a 10 00 0a 00 08 04 01 06 01 00 00 00 00 00 00 01 00 01',
    '2a 01 00 08',
    '2a 09 00 09 05 00 00 00 02 00 00 00',

    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 ff ff ff ff',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('ff ff ff ff',)*4*16)),
    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 00 00 00 00',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('00 00 00 00',)*4*16)),
    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 e2 e0 03 fe',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('e2 e0 03 fe',)*4*16)),
    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 1d 1f fc 01',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('1d 1f fc 01',)*4*16)),
    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 aa cc 33 55',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('aa cc 33 55',)*4*16)),
    '2a 15 00 0b 20 00 03 01 05 01 00 00 00 00 00 00 01 00 04 00 55 33 cc aa',
    '2a 13 01 0c 00 08 03 01 05 01 00 00 00 00 00 00 01 00 00 01 00 01 {}'.format(' '.join(('55 33 cc aa',)*4*16)),

    '2a 01 00 1a',
    '2a 01 00 2f',
    '2a 01 00 02'
)

# ------------------------------------------

def xds_test(dev, reset=True):
   
    if reset:
        xds_reset(dev)
    
    ep2o = usb_point(dev, 2, 2)
    ep2i = usb_point(dev, 2, 3)

    _ = dev.read(ep2i.bEndpointAddress, 1024)

    def send(epo, msg, epi=None):
        _ = epo.write(hex2dec(msg))
        if epi is not None:
            buf = dev.read(epi.bEndpointAddress, 1024)
            return buf
        return None

    def collect(v):
        res = send(ep2o, v, ep2i)
        if res is not None:
            if len(res) > 21:
                res = set(res[8:])
                if len(res) % 3 != 1:  # super-lazy check
                    return False
        return True
        
    for entry in __scan_test__:
        if not collect(entry):
            raise Exception('integrity scan-test on the JTAG DR/IR has failed')
